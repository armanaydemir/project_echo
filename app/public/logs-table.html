<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logs Table - Project Echo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-weight: 400;
      font-size: 16px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .review-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(234, 179, 8, 0.15);
      border-radius: 20px;
      font-size: 12px;
      color: #eab308;
      cursor: pointer;
      transition: background 0.2s;
    }

    .review-indicator:hover {
      background: rgba(234, 179, 8, 0.25);
    }

    .review-dot {
      width: 6px;
      height: 6px;
      background: #eab308;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .header a {
      color: #666;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }

    .header a:hover {
      color: #e0e0e0;
    }

    /* Filter Bar */
    .filter-bar {
      padding: 16px 24px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border: 1px solid #333;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.03);
      color: #e0e0e0;
      font-size: 14px;
    }

    .search-input::placeholder {
      color: #555;
    }

    .search-input:focus {
      outline: none;
      border-color: #555;
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-select {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #333;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 13px;
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: #555;
    }

    /* Main Content */
    .main-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Log Cards */
    .logs-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .log-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px 20px;
      position: relative;
      transition: all 0.15s ease;
    }

    .log-card:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: #333;
    }

    .log-card.needs-review {
      border-left: 3px solid #eab308;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .log-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .log-timestamp {
      font-size: 11px;
      font-family: monospace;
      color: #666;
    }

    .log-indicators {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .indicator {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      width: fit-content;
    }

    .indicator-private {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }

    .indicator-edited {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      cursor: pointer;
    }

    .indicator-edited:hover {
      background: rgba(59, 130, 246, 0.25);
    }

    .log-body {
      min-width: 0;
    }

    .log-content {
      font-size: 14px;
      line-height: 1.6;
      color: #e0e0e0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .log-content-truncated {
      max-height: 4.2em;
      overflow: hidden;
      position: relative;
    }

    .log-content-truncated::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1.5em;
      background: linear-gradient(transparent, rgba(10, 10, 10, 0.95));
    }

    .expand-toggle {
      margin-top: 6px;
      padding: 0;
      background: none;
      border: none;
      color: #666;
      font-size: 11px;
      cursor: pointer;
    }

    .expand-toggle:hover {
      color: #e0e0e0;
    }

    .log-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.08);
      color: #888;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tag:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #e0e0e0;
    }

    .tag-needs-review {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .log-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .edit-btn {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
      background: transparent;
      color: #666;
      opacity: 0;
    }

    .log-card:hover .edit-btn {
      opacity: 1;
    }

    .edit-btn:hover {
      color: #e0e0e0;
      background: rgba(255, 255, 255, 0.05);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid #333;
      background: rgba(255, 255, 255, 0.03);
      color: #e0e0e0;
      white-space: nowrap;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: #444;
    }

    .action-btn-review {
      background: rgba(234, 179, 8, 0.15);
      border-color: rgba(234, 179, 8, 0.3);
      color: #eab308;
    }

    .action-btn-review:hover {
      background: rgba(234, 179, 8, 0.25);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      font-weight: 400;
      margin-bottom: 8px;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 24px 0;
      margin-top: 16px;
    }

    .pagination-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #333;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.08);
      border-color: #444;
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 13px;
      color: #666;
    }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #151515;
      border: 1px solid #333;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 500;
    }

    .modal-close {
      background: none;
      border: none;
      color: #666;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: #e0e0e0;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #222;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .preview-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #222;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .preview-timestamp {
      font-size: 11px;
      font-family: monospace;
      color: #666;
      margin-bottom: 8px;
    }

    .preview-content {
      font-size: 14px;
      line-height: 1.5;
      color: #ccc;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .tag-input-wrapper {
      position: relative;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
    }

    .tag-input {
      flex: 1;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #333;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 14px;
    }

    .tag-add-btn {
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tag-add-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      border-color: #444;
    }

    .tag-input::placeholder {
      color: #555;
    }

    .tag-input:focus {
      outline: none;
      border-color: #555;
    }

    .tag-suggestions {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    .tag-suggestions.active {
      display: block;
    }

    .tag-suggestion {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
    }

    .tag-suggestion:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .selected-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      font-size: 12px;
      color: #e0e0e0;
    }

    .selected-tag.tag-needs-review {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .selected-tag button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      opacity: 0.6;
    }

    .selected-tag button:hover {
      opacity: 1;
    }

    .edit-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #333;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.5;
    }

    .edit-textarea:focus {
      outline: none;
      border-color: #555;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-row input {
      width: 16px;
      height: 16px;
    }

    .checkbox-row label {
      font-size: 14px;
      color: #e0e0e0;
      cursor: pointer;
    }

    .btn-primary {
      padding: 10px 20px;
      background: linear-gradient(135deg, #333 0%, #222 100%);
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #444 0%, #333 100%);
      border-color: #555;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: transparent;
      color: #888;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      color: #e0e0e0;
      border-color: #444;
    }

    /* Version History */
    .version-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .version-item {
      padding: 12px;
      border-bottom: 1px solid #222;
    }

    .version-item:last-child {
      border-bottom: none;
    }

    .version-item.current {
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .version-meta {
      font-size: 11px;
      font-family: monospace;
      color: #666;
      margin-bottom: 8px;
    }

    .version-meta .current-badge {
      margin-left: 8px;
      padding: 2px 6px;
      background: #3b82f6;
      color: #fff;
      border-radius: 3px;
      font-size: 9px;
      font-family: system-ui;
    }

    .version-content {
      font-size: 14px;
      line-height: 1.5;
      color: #aaa;
      white-space: pre-wrap;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        padding: 14px 16px;
      }

      .filter-bar {
        padding: 14px 16px;
        flex-direction: column;
      }

      .search-input {
        min-width: 100%;
      }

      .main-content {
        padding: 16px;
      }

      .log-card {
        padding: 14px 16px;
      }

      .log-header {
        flex-wrap: wrap;
        gap: 8px;
      }

      .edit-btn {
        opacity: 1;
      }

      .modal {
        max-height: 100%;
        border-radius: 8px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Logs Table</h1>
    <div class="header-nav">
      <div class="review-indicator" id="reviewIndicator" onclick="filterByTag('needs review')" style="display: none;">
        <span class="review-dot"></span>
        <span id="needsReviewCount">0 need review</span>
      </div>
      <a href="/">Home</a>
      <a href="/chat">Chat</a>
    </div>
  </header>

  <div class="filter-bar">
    <input type="text" class="search-input" id="searchInput" placeholder="Search logs...">
    <select class="filter-select" id="tagFilter">
      <option value="">All tags</option>
      <option value="needs review">Needs review</option>
    </select>
    <select class="filter-select" id="privateFilter">
      <option value="">All logs</option>
      <option value="public">Public only</option>
      <option value="private">Private only</option>
    </select>
    <select class="filter-select" id="sortSelect">
      <option value="newest">Newest first</option>
      <option value="oldest">Oldest first</option>
      <option value="edited">Recently edited</option>
    </select>
  </div>

  <main class="main-content">
    <div class="logs-list" id="logsList"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <h3>No logs found</h3>
      <p>Try adjusting your filters or create some logs first.</p>
    </div>

    <div class="pagination" id="pagination" style="display: none;">
      <button class="pagination-btn" id="prevBtn">Previous</button>
      <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
      <button class="pagination-btn" id="nextBtn">Next</button>
    </div>
  </main>

  <!-- Review Modal -->
  <div class="modal-overlay" id="reviewModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Review Log</h2>
        <button class="modal-close" onclick="closeModal('reviewModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="preview-card">
          <div class="preview-timestamp" id="reviewLogTime"></div>
          <div class="preview-content" id="reviewLogContent"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Add Tags</label>
          <div class="tag-input-wrapper">
            <div class="tag-input-row">
              <input type="text" class="tag-input" id="reviewTagInput" placeholder="Type a tag...">
              <button type="button" class="tag-add-btn" id="reviewTagAddBtn">Add</button>
            </div>
            <div class="tag-suggestions" id="reviewTagSuggestions"></div>
          </div>
          <div class="selected-tags" id="reviewSelectedTags"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('reviewModal')">Cancel</button>
        <button class="btn-primary" id="saveReviewBtn">Save & Mark Reviewed</button>
      </div>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div class="modal-overlay" id="addTagModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Manage Tags</h2>
        <button class="modal-close" onclick="closeModal('addTagModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="preview-card">
          <div class="preview-timestamp" id="addTagLogTime"></div>
          <div class="preview-content" id="addTagLogContent"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Current Tags</label>
          <div class="selected-tags" id="addTagCurrentTags"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Add New Tag</label>
          <div class="tag-input-wrapper">
            <div class="tag-input-row">
              <input type="text" class="tag-input" id="addTagInput" placeholder="Type a tag...">
              <button type="button" class="tag-add-btn" id="addTagAddBtn">Add</button>
            </div>
            <div class="tag-suggestions" id="addTagSuggestions"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('addTagModal')">Cancel</button>
        <button class="btn-primary" id="saveAddTagBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Edit Log</h2>
        <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Content</label>
          <textarea class="edit-textarea" id="editContent"></textarea>
        </div>
        <div class="form-group">
          <div class="checkbox-row">
            <input type="checkbox" id="editPrivate">
            <label for="editPrivate">Private log</label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div class="tag-input-wrapper">
            <div class="tag-input-row">
              <input type="text" class="tag-input" id="editTagInput" placeholder="Type a tag...">
              <button type="button" class="tag-add-btn" id="editTagAddBtn">Add</button>
            </div>
            <div class="tag-suggestions" id="editTagSuggestions"></div>
          </div>
          <div class="selected-tags" id="editSelectedTags"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('editModal')">Cancel</button>
        <button class="btn-primary" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div class="modal-overlay" id="historyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Version History</h2>
        <button class="modal-close" onclick="closeModal('historyModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="version-list" id="versionList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal('historyModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let allLogs = [];
    let filteredLogs = [];
    let knownTags = [];
    let currentPage = 1;
    const pageSize = 20;

    // Elements
    const logsList = document.getElementById('logsList');
    const emptyState = document.getElementById('emptyState');
    const needsReviewCount = document.getElementById('needsReviewCount');
    const reviewIndicator = document.getElementById('reviewIndicator');
    const searchInput = document.getElementById('searchInput');
    const tagFilter = document.getElementById('tagFilter');
    const privateFilter = document.getElementById('privateFilter');
    const sortSelect = document.getElementById('sortSelect');

    async function loadLogs() {
      try {
        const res = await fetch('/logs');
        allLogs = await res.json();
        applyFilters();
        updateNeedsReviewCount();
      } catch (e) {
        console.error('Failed to load logs:', e);
      }
    }

    async function loadTags() {
      try {
        const res = await fetch('/api/tags');
        const data = await res.json();
        knownTags = data.tags || [];
        updateTagFilterOptions();
      } catch (e) {
        console.error('Failed to load tags:', e);
      }
    }

    function updateTagFilterOptions() {
      const currentValue = tagFilter.value;
      tagFilter.innerHTML = '<option value="">All tags</option>';
      knownTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagFilter.appendChild(option);
      });
      tagFilter.value = currentValue;
    }

    function updateNeedsReviewCount() {
      const count = allLogs.filter(log => log.tags && log.tags.includes('needs review')).length;
      needsReviewCount.textContent = `${count} need review`;
      reviewIndicator.style.display = count > 0 ? 'flex' : 'none';
    }

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const tagFilterValue = tagFilter.value;
      const privateFilterValue = privateFilter.value;
      const sortValue = sortSelect.value;

      filteredLogs = allLogs.filter(log => {
        const isPrivate = log.tags && log.tags.includes('private');
        if (searchTerm && !log.content.toLowerCase().includes(searchTerm)) return false;
        if (tagFilterValue && (!log.tags || !log.tags.includes(tagFilterValue))) return false;
        if (privateFilterValue === 'public' && isPrivate) return false;
        if (privateFilterValue === 'private' && !isPrivate) return false;
        return true;
      });

      filteredLogs.sort((a, b) => {
        if (sortValue === 'newest') return new Date(b.timestamp) - new Date(a.timestamp);
        if (sortValue === 'oldest') return new Date(a.timestamp) - new Date(b.timestamp);
        if (sortValue === 'edited') {
          return new Date(b.editedAt || b.timestamp) - new Date(a.editedAt || a.timestamp);
        }
        return 0;
      });

      currentPage = 1;
      renderLogs();
    }

    function renderLogs() {
      const start = (currentPage - 1) * pageSize;
      const pageLogs = filteredLogs.slice(start, start + pageSize);

      if (pageLogs.length === 0) {
        logsList.innerHTML = '';
        emptyState.style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';

      logsList.innerHTML = pageLogs.map(log => {
        const hasNeedsReview = log.tags && log.tags.includes('needs review');
        const isPrivate = log.tags && log.tags.includes('private');
        const versionCount = (log.versions || []).length;
        const isLong = log.content.length > 200;

        // Filter out 'private' from displayed tags
        const displayTags = (log.tags || []).filter(t => t !== 'private');
        const tags = displayTags.map(tag =>
          `<span class="tag ${tag === 'needs review' ? 'tag-needs-review' : ''}" onclick="filterByTag('${escapeHtml(tag)}')">${escapeHtml(tag)}</span>`
        ).join('');

        return `
          <article class="log-card ${hasNeedsReview ? 'needs-review' : ''}">
            <div class="log-header">
              <div class="log-header-left">
                <time class="log-timestamp">${formatTime(log.timestamp)}</time>
                <div class="log-indicators">
                  ${isPrivate ? '<span class="indicator indicator-private">Private</span>' : ''}
                  ${versionCount > 0 ? `<span class="indicator indicator-edited" onclick="showHistory('${log.id}')">Edited (${versionCount})</span>` : ''}
                </div>
              </div>
              <button class="edit-btn" onclick="openEditModal('${log.id}')">Edit</button>
            </div>
            <div class="log-body">
              <div class="log-content ${isLong ? 'log-content-truncated' : ''}" id="content-${log.id}">${escapeHtml(log.content)}</div>
              ${isLong ? `<button class="expand-toggle" onclick="toggleExpand('${log.id}')">Show more</button>` : ''}
            </div>
            <div class="log-footer">
              ${hasNeedsReview ? `<button class="action-btn action-btn-review" onclick="openReviewModal('${log.id}')">Review</button>` : `<button class="action-btn" onclick="openAddTagModal('${log.id}')">+ Tag</button>`}
              ${tags ? `<div class="log-tags">${tags}</div>` : ''}
            </div>
          </article>
        `;
      }).join('');

      const totalPages = Math.ceil(filteredLogs.length / pageSize);
      const pagination = document.getElementById('pagination');
      if (totalPages > 1) {
        pagination.style.display = 'flex';
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    function toggleExpand(logId) {
      const content = document.getElementById(`content-${logId}`);
      const btn = content.nextElementSibling;
      content.classList.toggle('log-content-truncated');
      if (btn) btn.textContent = content.classList.contains('log-content-truncated') ? 'Show more' : 'Show less';
    }

    function filterByTag(tag) {
      tagFilter.value = tag;
      applyFilters();
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      document.body.style.overflow = '';
    }

    function getLogById(id) {
      return allLogs.find(log => log.id === id);
    }

    // Review Modal
    let reviewLog = null;
    let reviewTags = [];

    function openReviewModal(logId) {
      reviewLog = getLogById(logId);
      if (!reviewLog) return;
      document.getElementById('reviewLogTime').textContent = formatTime(reviewLog.timestamp);
      document.getElementById('reviewLogContent').textContent = reviewLog.content;
      // Filter out 'needs review' (will be removed on save) and 'private' (handled separately)
      reviewTags = (reviewLog.tags || []).filter(t => t !== 'needs review' && t !== 'private');
      renderReviewTags();
      document.getElementById('reviewTagInput').value = '';
      openModal('reviewModal');
    }

    function renderReviewTags() {
      const container = document.getElementById('reviewSelectedTags');
      container.innerHTML = reviewTags.length ? reviewTags.map(tag =>
        `<span class="selected-tag">${escapeHtml(tag)}<button onclick="removeReviewTag('${escapeHtml(tag)}')">&times;</button></span>`
      ).join('') : '<span style="color:#666;font-size:12px;">No tags yet</span>';
    }

    function removeReviewTag(tag) {
      reviewTags = reviewTags.filter(t => t !== tag);
      renderReviewTags();
    }

    function addReviewTag(tag) {
      const trimmed = tag.trim().toLowerCase();
      if (trimmed && !reviewTags.includes(trimmed)) {
        reviewTags.push(trimmed);
        renderReviewTags();
      }
    }

    document.getElementById('reviewTagInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addReviewTag(e.target.value);
        e.target.value = '';
        hideTagSuggestions('reviewTagSuggestions');
      }
    });

    document.getElementById('reviewTagInput').addEventListener('input', (e) => {
      showTagSuggestions(e.target.value, 'reviewTagSuggestions', addReviewTag);
    });

    document.getElementById('reviewTagAddBtn').addEventListener('click', () => {
      const input = document.getElementById('reviewTagInput');
      addReviewTag(input.value);
      input.value = '';
      hideTagSuggestions('reviewTagSuggestions');
    });

    document.getElementById('saveReviewBtn').addEventListener('click', async () => {
      if (!reviewLog) return;
      try {
        // Preserve private tag if it was set
        const wasPrivate = reviewLog.tags && reviewLog.tags.includes('private');
        const tagsToSave = wasPrivate ? [...reviewTags, 'private'] : reviewTags;
        await fetch(`/logs/${reviewLog.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags: tagsToSave })
        });
        closeModal('reviewModal');
        await loadLogs();
        await loadTags();
      } catch (e) {
        alert('Failed to save');
      }
    });

    // Add Tag Modal
    let addTagLog = null;
    let addTagTags = [];

    function openAddTagModal(logId) {
      addTagLog = getLogById(logId);
      if (!addTagLog) return;
      document.getElementById('addTagLogTime').textContent = formatTime(addTagLog.timestamp);
      document.getElementById('addTagLogContent').textContent = addTagLog.content;
      // Filter out 'private' - handled separately
      addTagTags = (addTagLog.tags || []).filter(t => t !== 'private');
      renderAddTagTags();
      document.getElementById('addTagInput').value = '';
      openModal('addTagModal');
    }

    function renderAddTagTags() {
      const container = document.getElementById('addTagCurrentTags');
      container.innerHTML = addTagTags.length ? addTagTags.map(tag =>
        `<span class="selected-tag ${tag === 'needs review' ? 'tag-needs-review' : ''}">${escapeHtml(tag)}<button onclick="removeAddTagTag('${escapeHtml(tag)}')">&times;</button></span>`
      ).join('') : '<span style="color:#666;font-size:12px;">No tags</span>';
    }

    function removeAddTagTag(tag) {
      addTagTags = addTagTags.filter(t => t !== tag);
      renderAddTagTags();
    }

    function addAddTagTag(tag) {
      const trimmed = tag.trim().toLowerCase();
      if (trimmed && !addTagTags.includes(trimmed)) {
        addTagTags.push(trimmed);
        renderAddTagTags();
      }
    }

    document.getElementById('addTagInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addAddTagTag(e.target.value);
        e.target.value = '';
        hideTagSuggestions('addTagSuggestions');
      }
    });

    document.getElementById('addTagInput').addEventListener('input', (e) => {
      showTagSuggestions(e.target.value, 'addTagSuggestions', addAddTagTag);
    });

    document.getElementById('addTagAddBtn').addEventListener('click', () => {
      const input = document.getElementById('addTagInput');
      addAddTagTag(input.value);
      input.value = '';
      hideTagSuggestions('addTagSuggestions');
    });

    document.getElementById('saveAddTagBtn').addEventListener('click', async () => {
      if (!addTagLog) return;
      try {
        // Preserve private tag if it was set
        const wasPrivate = addTagLog.tags && addTagLog.tags.includes('private');
        const tagsToSave = wasPrivate ? [...addTagTags, 'private'] : addTagTags;
        await fetch(`/logs/${addTagLog.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags: tagsToSave })
        });
        closeModal('addTagModal');
        await loadLogs();
        await loadTags();
      } catch (e) {
        alert('Failed to save');
      }
    });

    // Edit Modal
    let editLog = null;
    let editTags = [];

    function openEditModal(logId) {
      editLog = getLogById(logId);
      if (!editLog) return;
      document.getElementById('editContent').value = editLog.content;
      const isPrivate = editLog.tags && editLog.tags.includes('private');
      document.getElementById('editPrivate').checked = isPrivate;
      // Filter out 'private' from editable tags (handled by checkbox)
      editTags = (editLog.tags || []).filter(t => t !== 'private');
      renderEditTags();
      document.getElementById('editTagInput').value = '';
      openModal('editModal');
    }

    function renderEditTags() {
      const container = document.getElementById('editSelectedTags');
      container.innerHTML = editTags.length ? editTags.map(tag =>
        `<span class="selected-tag ${tag === 'needs review' ? 'tag-needs-review' : ''}">${escapeHtml(tag)}<button onclick="removeEditTag('${escapeHtml(tag)}')">&times;</button></span>`
      ).join('') : '<span style="color:#666;font-size:12px;">No tags</span>';
    }

    function removeEditTag(tag) {
      editTags = editTags.filter(t => t !== tag);
      renderEditTags();
    }

    function addEditTag(tag) {
      const trimmed = tag.trim().toLowerCase();
      if (trimmed && !editTags.includes(trimmed)) {
        editTags.push(trimmed);
        renderEditTags();
      }
    }

    document.getElementById('editTagInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addEditTag(e.target.value);
        e.target.value = '';
        hideTagSuggestions('editTagSuggestions');
      }
    });

    document.getElementById('editTagInput').addEventListener('input', (e) => {
      showTagSuggestions(e.target.value, 'editTagSuggestions', addEditTag);
    });

    document.getElementById('editTagAddBtn').addEventListener('click', () => {
      const input = document.getElementById('editTagInput');
      addEditTag(input.value);
      input.value = '';
      hideTagSuggestions('editTagSuggestions');
    });

    document.getElementById('saveEditBtn').addEventListener('click', async () => {
      if (!editLog) return;
      const content = document.getElementById('editContent').value.trim();
      const isPrivate = document.getElementById('editPrivate').checked;
      if (!content) { alert('Content cannot be empty'); return; }
      try {
        await fetch(`/logs/${editLog.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, private: isPrivate, tags: editTags })
        });
        closeModal('editModal');
        await loadLogs();
        await loadTags();
      } catch (e) {
        alert('Failed to save');
      }
    });

    // Version History
    function showHistory(logId) {
      const log = getLogById(logId);
      if (!log) return;
      const versions = log.versions || [];
      const versionList = document.getElementById('versionList');

      let html = `
        <div class="version-item current">
          <div class="version-meta">${formatTime(log.editedAt || log.timestamp)}<span class="current-badge">Current</span></div>
          <div class="version-content">${escapeHtml(log.content)}</div>
        </div>
      `;

      html += [...versions].reverse().map(v => `
        <div class="version-item">
          <div class="version-meta">${formatTime(v.editedAt)}</div>
          <div class="version-content">${escapeHtml(v.content)}</div>
        </div>
      `).join('');

      versionList.innerHTML = html;
      openModal('historyModal');
    }

    // Tag suggestions
    function showTagSuggestions(value, suggestionsId, addCallback) {
      const suggestions = document.getElementById(suggestionsId);
      const trimmed = value.trim().toLowerCase();
      if (!trimmed) { suggestions.classList.remove('active'); return; }
      const matches = knownTags.filter(tag => tag.toLowerCase().includes(trimmed) && tag.toLowerCase() !== trimmed);
      if (matches.length === 0) { suggestions.classList.remove('active'); return; }
      suggestions.innerHTML = matches.slice(0, 5).map(tag =>
        `<div class="tag-suggestion" onclick="selectTagSuggestion('${escapeHtml(tag)}', '${suggestionsId}')">${escapeHtml(tag)}</div>`
      ).join('');
      suggestions.classList.add('active');
    }

    function hideTagSuggestions(suggestionsId) {
      document.getElementById(suggestionsId).classList.remove('active');
    }

    function selectTagSuggestion(tag, suggestionsId) {
      if (suggestionsId === 'reviewTagSuggestions') { addReviewTag(tag); document.getElementById('reviewTagInput').value = ''; }
      else if (suggestionsId === 'addTagSuggestions') { addAddTagTag(tag); document.getElementById('addTagInput').value = ''; }
      else if (suggestionsId === 'editTagSuggestions') { addEditTag(tag); document.getElementById('editTagInput').value = ''; }
      hideTagSuggestions(suggestionsId);
    }

    // Close modals
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) { overlay.classList.remove('active'); document.body.style.overflow = ''; }
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => {
          m.classList.remove('active'); document.body.style.overflow = '';
        });
      }
    });

    // Pagination
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; renderLogs(); }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentPage < Math.ceil(filteredLogs.length / pageSize)) { currentPage++; renderLogs(); }
    });

    // Filters
    searchInput.addEventListener('input', debounce(applyFilters, 300));
    tagFilter.addEventListener('change', applyFilters);
    privateFilter.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);

    function debounce(fn, delay) {
      let timeoutId;
      return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => fn(...args), delay); };
    }

    loadLogs();
    loadTags();
  </script>
</body>
</html>
