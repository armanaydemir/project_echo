<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Project Echo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid #222;
    }

    .header h1 {
      font-weight: 400;
      font-size: 16px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header a {
      color: #666;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }

    .header a:hover {
      color: #e0e0e0;
    }

    .model-select {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #333;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .model-select:focus {
      outline: none;
      border-color: #555;
    }

    .model-select:hover {
      border-color: #444;
    }

    .status {
      padding: 10px 24px;
      font-size: 13px;
      border-bottom: 1px solid #222;
    }

    .status.success {
      background: rgba(46, 160, 67, 0.1);
      color: #3fb950;
    }

    .status.error {
      background: rgba(248, 81, 73, 0.1);
      color: #f85149;
    }

    .status.checking {
      background: rgba(255, 255, 255, 0.03);
      color: #666;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #1a4a6e 0%, #123a54 100%);
      border: 1px solid #1e5a84;
      color: #e0e0e0;
    }

    .message.assistant {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #222;
      color: #ccc;
    }

    .message.error {
      align-self: flex-start;
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid rgba(248, 81, 73, 0.3);
      color: #f85149;
    }

    .input-area {
      padding: 20px 24px;
      background: rgba(255, 255, 255, 0.02);
      border-top: 1px solid #222;
    }

    .input-form {
      display: flex;
      gap: 12px;
      max-width: 800px;
      margin: 0 auto;
    }

    .input-form input {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid #333;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      color: #e0e0e0;
      font-size: 15px;
      transition: border-color 0.3s, background 0.3s;
    }

    .input-form input:focus {
      outline: none;
      border-color: #555;
      background: rgba(255, 255, 255, 0.05);
    }

    .input-form input::placeholder {
      color: #555;
    }

    .input-form button {
      padding: 14px 28px;
      background: linear-gradient(135deg, #333 0%, #222 100%);
      color: #fff;
      border: 1px solid #444;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .input-form button:hover {
      background: linear-gradient(135deg, #444 0%, #333 100%);
      border-color: #555;
    }

    .input-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Chat with Logs</h1>
    <div class="header-right">
      <select class="model-select" id="modelSelect">
        <option>Loading models...</option>
      </select>
      <a href="/logs-table">Logs Table</a>
      <a href="/">Home</a>
    </div>
  </div>

  <div class="status checking" id="status">Checking Ollama status...</div>

  <div class="messages" id="messages">
    <div class="message assistant">
      Welcome! Ask me anything about your logs and I'll help you analyze them.
    </div>
  </div>

  <div class="input-area">
    <form class="input-form" id="chatForm">
      <input type="text" id="chatInput" placeholder="Ask about your logs..." autocomplete="off">
      <button type="submit" id="sendBtn">Send</button>
    </form>
  </div>

  <script>
    const status = document.getElementById('status');
    const messages = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const modelSelect = document.getElementById('modelSelect');

    let messageIdCounter = 0;

    async function loadModels() {
      try {
        const res = await fetch('/api/models');
        const data = await res.json();

        modelSelect.innerHTML = data.models.map(m =>
          `<option value="${m.id}" ${m.active ? 'selected' : ''}>${m.name}</option>`
        ).join('');
      } catch (e) {
        modelSelect.innerHTML = '<option>Failed to load</option>';
      }
    }

    modelSelect.addEventListener('change', async () => {
      const model = modelSelect.value;
      try {
        await fetch('/api/models', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model })
        });
        status.className = 'status success';
        status.textContent = `Switched to ${model}`;
      } catch (e) {
        status.className = 'status error';
        status.textContent = 'Failed to switch model';
      }
    });

    async function checkOllamaStatus() {
      status.className = 'status checking';
      status.textContent = 'Checking Ollama status...';

      try {
        const res = await fetch('/api/ollama/status');
        const data = await res.json();

        if (data.status === 'running') {
          status.className = 'status success';
          const modelName = data.models?.[0]?.name || 'ready';
          status.textContent = `Connected to Ollama (${modelName})`;
        } else {
          status.className = 'status error';
          status.textContent = data.error || 'Ollama not available';
        }
      } catch (e) {
        status.className = 'status error';
        status.textContent = 'Failed to check Ollama status';
      }
    }

    function addMessage(content, type = 'assistant') {
      const id = 'msg-' + (++messageIdCounter);
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.id = id;
      msgDiv.textContent = content;
      messages.appendChild(msgDiv);
      messages.scrollTop = messages.scrollHeight;
      return id;
    }

    function updateMessage(id, content) {
      const msg = document.getElementById(id);
      if (msg) {
        msg.textContent = content;
        messages.scrollTop = messages.scrollHeight;
      }
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;

      addMessage(message, 'user');
      chatInput.value = '';
      sendBtn.disabled = true;

      const assistantId = addMessage('', 'assistant');
      let fullResponse = '';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          updateMessage(assistantId, errorData.error || `Error: ${res.status}`);
          document.getElementById(assistantId).className = 'message error';
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                if (data.content) {
                  fullResponse += data.content;
                  updateMessage(assistantId, fullResponse);
                }
              } catch (e) {
                // Skip malformed JSON
              }
            }
          }
        }

        if (!fullResponse) {
          updateMessage(assistantId, 'No response received');
        }
      } catch (e) {
        updateMessage(assistantId, 'Failed to send message. Please try again.');
        document.getElementById(assistantId).className = 'message error';
      } finally {
        sendBtn.disabled = false;
        chatInput.focus();
      }
    });

    checkOllamaStatus();
    loadModels();
    chatInput.focus();
  </script>
</body>
</html>
